<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Change Password</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 400px;
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="card">
        <h3 class="text-center text-primary mb-4">Change Password</h3>

        <form id="changePasswordForm" th:action="@{/user/update-password/{id}(id=${user.id})}" method="post">

            <div class="mb-3">
                <label for="currentPassword" class="form-label">Current Password</label>
                <input type="password" id="currentPassword" name="currentPassword" class="form-control" required
                    minlength="6">
            </div>

            <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <input type="password" id="newPassword" name="newPassword" class="form-control" required minlength="6">
            </div>

            <div class="mb-3">
                <label for="confirmPassword" class="form-label">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required
                    minlength="6">
            </div>

            <div class="d-flex justify-content-between">
                <a class="btn btn-secondary" th:if="${loggedInUser.role == 'STUDENT'}" th:href="@{/user/view}">
                    Cancel
                </a>
                <a class="btn btn-secondary" th:unless="${loggedInUser.role == 'STUDENT'}" th:href="@{/user/view}">
                    Cancel
                </a>
                <button type="button" class="btn btn-primary" onclick="confirmUpdate(event)">Update</button>
            </div>
        </form>
    </div>

    <script>
        function confirmUpdate(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const form = document.getElementById('changePasswordForm');
            const url = form.action;
            if (newPassword !== confirmPassword) {
                Swal.fire('Error', 'New Password and Confirm Password do not match.', 'error');
                return;
            }

            else {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "Do you want to update your password?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, Update!'
                }).then(result => {
                    if (result.isConfirmed) {
                        const formData = new FormData(form);

                        fetch(form.action, {
                            method: form.method,
                            body: formData
                        })
                            .then(async response => {
                                const data = await response.json().catch(() => ({}));

                                if (response.ok) {
                                    Swal.fire({
                                        title: 'Success!',
                                        text: data.message || 'Password updated successfully!',
                                        icon: 'success',
                                        confirmButtonText: 'OK'
                                    }).then(() => {
                                        window.location.href = "/user/view";
                                    });
                                } else {
                                    Swal.fire({
                                        title: 'Error!',
                                        text: data.message || 'An error occurred while saving.',
                                        icon: 'error',
                                        confirmButtonText: 'OK'
                                    });
                                }
                            })
                            .catch(() => {
                                Swal.fire({
                                    title: 'Error!',
                                    text: 'An unexpected error occurred. Please try again later.',
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                });
                            });
                    }
                });
            }
        }
    </script>
</body>

</html>